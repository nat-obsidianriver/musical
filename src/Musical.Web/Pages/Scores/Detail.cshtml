@page "{id:int}"
@model DetailModel
@{
    ViewData["Title"] = Model.Score?.Title ?? "Score Detail";

    Microsoft.AspNetCore.Html.HtmlString LinkifyContent(string text)
    {
        var urlPattern = new System.Text.RegularExpressions.Regex(
            @"https?://[^\s<>""]+",
            System.Text.RegularExpressions.RegexOptions.IgnoreCase);

        var sb = new System.Text.StringBuilder();
        int lastIndex = 0;

        foreach (System.Text.RegularExpressions.Match m in urlPattern.Matches(text))
        {
            sb.Append(System.Net.WebUtility.HtmlEncode(text[lastIndex..m.Index]));
            var url = System.Net.WebUtility.HtmlEncode(m.Value);
            sb.Append($"<a href=\"{url}\" target=\"_blank\" rel=\"noopener noreferrer\">{url}</a>");
            lastIndex = m.Index + m.Length;
        }
        sb.Append(System.Net.WebUtility.HtmlEncode(text[lastIndex..]));

        return new Microsoft.AspNetCore.Html.HtmlString(sb.ToString());
    }

    string Fmt(double v) => v.ToString("F2", System.Globalization.CultureInfo.InvariantCulture);
}

@if (Model.Score is null)
{
    <div class="alert alert-warning">Score not found.</div>
    <a asp-page="/Index" class="btn btn-outline-secondary">Back to Library</a>
    return;
}

<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h1 class="h2 mb-0">@Model.Score.Title</h1>
        @if (!string.IsNullOrEmpty(Model.Score.Composer))
        {
            <p class="text-muted mb-0">@Model.Score.Composer</p>
        }
        @if (!string.IsNullOrEmpty(Model.Score.Description))
        {
            <p class="small mt-1">@Model.Score.Description</p>
        }
    </div>
    <a asp-page="/Index" class="btn btn-outline-secondary btn-sm">&#8592; Back</a>
</div>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<div class="row g-4">
    <!-- Image with annotation overlay -->
    <div class="col-lg-8">
        <p class="text-muted small mb-1">Click to add a point annotation, or click and drag to mark a range.</p>
        <div id="score-container" class="position-relative border rounded shadow-sm overflow-hidden"
             style="cursor:crosshair; user-select:none;">
            <img id="score-image"
                 src="@Model.ApiBase/api/scores/@Model.Score.Id/image"
                 alt="@Model.Score.Title"
                 class="img-fluid w-100 d-block"
                 draggable="false" />

            <!-- Drag preview rectangle -->
            <div id="drag-preview"
                 style="display:none;position:absolute;border:2px dashed #0d6efd;background:rgba(13,110,253,0.12);pointer-events:none;"></div>

            @foreach (var ann in Model.Annotations)
            {
                @if (ann.PositionXEnd.HasValue && ann.PositionYEnd.HasValue)
                {
                    var left   = Math.Min(ann.PositionX, ann.PositionXEnd.Value);
                    var top    = Math.Min(ann.PositionY, ann.PositionYEnd.Value);
                    var width  = Math.Abs(ann.PositionXEnd.Value - ann.PositionX);
                    var height = Math.Abs(ann.PositionYEnd.Value - ann.PositionY);
                    <div class="annotation-range"
                         data-id="@ann.Id"
                         style="left:@(Fmt(left))%;top:@(Fmt(top))%;width:@(Fmt(width))%;height:@(Fmt(height))%;position:absolute;background:rgba(220,53,69,0.18);border:2px solid rgba(220,53,69,0.75);cursor:pointer;box-sizing:border-box;"
                         title="@ann.AuthorName"></div>
                }
                else
                {
                    <div class="annotation-pin"
                         data-id="@ann.Id"
                         style="left:@(Fmt(ann.PositionX))%;top:@(Fmt(ann.PositionY))%;position:absolute;transform:translate(-50%,-50%);width:26px;height:26px;border-radius:50%;background:rgba(220,53,69,0.85);border:2px solid white;cursor:pointer;display:flex;align-items:center;justify-content:center;color:white;font-size:11px;font-weight:bold;"
                         title="@ann.AuthorName">
                        &#9670;
                    </div>
                }
            }
        </div>
    </div>

    <!-- Annotation panel -->
    <div class="col-lg-4">
        <!-- Add annotation form (hidden until user clicks/drags image) -->
        <div id="add-form-panel" class="card mb-3 d-none">
            <div class="card-header fw-semibold" style="background-color:#87CEEB;">
                <span id="form-mode-label">Add Annotation</span>
            </div>
            <div class="card-body">
                <form id="add-annotation-form" enctype="multipart/form-data">
                    <input type="hidden" id="pos-x" />
                    <input type="hidden" id="pos-y" />
                    <input type="hidden" id="pos-x-end" />
                    <input type="hidden" id="pos-y-end" />
                    <div class="mb-2">
                        <label for="author-name" class="form-label small fw-semibold">Your Name</label>
                        <input type="text" id="author-name" class="form-control form-control-sm"
                               placeholder="e.g. Jane Smith" maxlength="100" required />
                    </div>
                    <div class="mb-2">
                        <label for="annotation-content" class="form-label small fw-semibold">Note</label>
                        <textarea id="annotation-content" class="form-control form-control-sm" rows="3"
                                  placeholder="Your annotation... paste a URL to create a link." maxlength="2000" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="attachment-file" class="form-label small fw-semibold">
                            Image Attachment <span class="text-muted fw-normal">(optional)</span>
                        </label>
                        <input type="file" id="attachment-file" class="form-control form-control-sm"
                               accept=".jpg,.jpeg,.png,.gif,.webp" />
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-sm btn-primary">Save</button>
                        <button type="button" id="cancel-annotation" class="btn btn-sm btn-outline-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Annotation list -->
        <div class="card">
            <div class="card-header fw-semibold d-flex justify-content-between align-items-center"
                 style="background-color:#87CEEB;">
                <span>Annotations</span>
                <span class="badge bg-dark">@Model.Annotations.Count</span>
            </div>
            <ul class="list-group list-group-flush" id="annotation-list">
                @if (!Model.Annotations.Any())
                {
                    <li class="list-group-item text-muted small">No annotations yet. Click the score to add one.</li>
                }
                else
                {
                    @foreach (var ann in Model.Annotations.OrderBy(a => a.CreatedAt))
                    {
                        <li class="list-group-item annotation-list-item" data-id="@ann.Id">

                            <!-- Collapsed row: always visible -->
                            <div class="annotation-collapsed d-flex justify-content-between align-items-center">
                                <span class="fw-semibold small">
                                    @if (ann.PositionXEnd.HasValue)
                                    {
                                        <span class="badge me-1" style="background:#dc3545;font-size:.65rem;">RANGE</span>
                                    }
                                    @ann.AuthorName
                                </span>
                                <span class="text-muted" style="font-size:.72rem;">@ann.CreatedAt.ToString("MMM d, yyyy")</span>
                            </div>

                            <!-- Expanded content -->
                            <div class="annotation-expanded">
                                <p class="mb-2 mt-2" style="font-size:.95rem;white-space:pre-wrap;">@LinkifyContent(ann.Content)</p>
                                @if (ann.AttachmentFileName is not null)
                                {
                                    <div class="mb-2">
                                        <img src="@Model.ApiBase/api/scores/@Model.Score.Id/annotations/@ann.Id/attachment"
                                             alt="Annotation attachment"
                                             class="img-fluid rounded"
                                             style="max-height:200px;cursor:pointer;"
                                             onclick="window.open(this.src,'_blank')" />
                                    </div>
                                }
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-sm btn-outline-danger delete-btn" data-id="@ann.Id">Delete</button>
                                </div>
                            </div>
                        </li>
                    }
                }
            </ul>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const scoreId = @Model.Score.Id;
    const apiBase = '@Model.ApiBase';

    const container = document.getElementById('score-container');
    const img       = document.getElementById('score-image');
    const addPanel  = document.getElementById('add-form-panel');
    const preview   = document.getElementById('drag-preview');

    // ── Expand / collapse list items ──────────────────────────────────
    function expandItem(li) {
        document.querySelectorAll('.annotation-list-item.is-expanded').forEach(el => {
            if (el !== li) collapseItem(el);
        });
        li.classList.add('is-expanded');
        li.querySelector('.annotation-expanded').style.maxHeight =
            li.querySelector('.annotation-expanded').scrollHeight + 'px';
    }

    function collapseItem(li) {
        li.classList.remove('is-expanded');
        li.querySelector('.annotation-expanded').style.maxHeight = '0';
    }

    // List item click
    document.querySelectorAll('.annotation-list-item').forEach(li => {
        li.addEventListener('click', function (e) {
            if (e.target.classList.contains('delete-btn')) return;
            this.classList.contains('is-expanded') ? collapseItem(this) : expandItem(this);
        });
    });

    // ── Pin / range click → expand matching list item ──────────────────
    function handleOverlayClick(e) {
        e.stopPropagation();
        const li = document.querySelector(`.annotation-list-item[data-id="${this.dataset.id}"]`);
        if (!li) return;
        addPanel.classList.add('d-none');
        expandItem(li);
        li.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    document.querySelectorAll('.annotation-pin, .annotation-range').forEach(el => {
        el.addEventListener('click', handleOverlayClick);
    });

    // ── Drag to place point or range annotation ────────────────────────
    let isDragging = false;
    let dragStart  = null;

    function imgCoords(e) {
        const rect = img.getBoundingClientRect();
        return {
            x: Math.max(0, Math.min(100, (e.clientX - rect.left) / rect.width  * 100)),
            y: Math.max(0, Math.min(100, (e.clientY - rect.top)  / rect.height * 100))
        };
    }

    container.addEventListener('mousedown', function (e) {
        if (e.target.classList.contains('annotation-pin') ||
            e.target.classList.contains('annotation-range')) return;
        if (e.button !== 0) return;
        isDragging = true;
        dragStart  = imgCoords(e);
        preview.style.left   = dragStart.x + '%';
        preview.style.top    = dragStart.y + '%';
        preview.style.width  = '0';
        preview.style.height = '0';
        preview.style.display = 'block';
        e.preventDefault();
    });

    container.addEventListener('mousemove', function (e) {
        if (!isDragging) return;
        const cur = imgCoords(e);
        const minX = Math.min(dragStart.x, cur.x);
        const minY = Math.min(dragStart.y, cur.y);
        preview.style.left   = minX + '%';
        preview.style.top    = minY + '%';
        preview.style.width  = Math.abs(cur.x - dragStart.x) + '%';
        preview.style.height = Math.abs(cur.y - dragStart.y) + '%';
    });

    function finishDrag(e) {
        if (!isDragging) return;
        isDragging = false;
        preview.style.display = 'none';

        const end     = imgCoords(e);
        const isRange = Math.abs(end.x - dragStart.x) > 2 || Math.abs(end.y - dragStart.y) > 2;

        document.getElementById('pos-x').value = dragStart.x.toFixed(2);
        document.getElementById('pos-y').value = dragStart.y.toFixed(2);
        document.getElementById('pos-x-end').value = isRange ? end.x.toFixed(2) : '';
        document.getElementById('pos-y-end').value = isRange ? end.y.toFixed(2) : '';

        document.getElementById('form-mode-label').textContent =
            isRange ? 'Add Range Annotation' : 'Add Annotation';

        document.querySelectorAll('.annotation-list-item.is-expanded').forEach(el => collapseItem(el));
        addPanel.classList.remove('d-none');
        document.getElementById('author-name').focus();
    }

    container.addEventListener('mouseup', finishDrag);
    document.addEventListener('mouseup', function (e) {
        if (isDragging) {
            isDragging = false;
            preview.style.display = 'none';
        }
    });

    document.getElementById('cancel-annotation').addEventListener('click', () => {
        addPanel.classList.add('d-none');
        document.getElementById('add-annotation-form').reset();
    });

    // ── Submit annotation ─────────────────────────────────────────────
    document.getElementById('add-annotation-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const author  = document.getElementById('author-name').value.trim();
        const content = document.getElementById('annotation-content').value.trim();
        if (!author || !content) return;

        const posXEnd = document.getElementById('pos-x-end').value;
        const posYEnd = document.getElementById('pos-y-end').value;

        const fd = new FormData();
        fd.append('authorName', author);
        fd.append('content',    content);
        fd.append('positionX',  document.getElementById('pos-x').value);
        fd.append('positionY',  document.getElementById('pos-y').value);
        if (posXEnd) fd.append('positionXEnd', posXEnd);
        if (posYEnd) fd.append('positionYEnd', posYEnd);
        const file = document.getElementById('attachment-file').files[0];
        if (file) fd.append('attachment', file);

        const res = await fetch(`${apiBase}/api/scores/${scoreId}/annotations`, {
            method: 'POST',
            body: fd
        });

        if (res.ok) { location.reload(); }
        else { alert('Failed to save annotation. Please try again.'); }
    });

    // ── Delete annotation ─────────────────────────────────────────────
    document.getElementById('annotation-list').addEventListener('click', async function (e) {
        const btn = e.target.closest('.delete-btn');
        if (!btn) return;
        if (!confirm('Delete this annotation?')) return;
        const res = await fetch(`${apiBase}/api/scores/${scoreId}/annotations/${btn.dataset.id}`, {
            method: 'DELETE'
        });
        if (res.ok) { location.reload(); }
        else { alert('Failed to delete annotation.'); }
    });
</script>
}
